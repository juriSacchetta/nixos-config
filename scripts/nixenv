#!/usr/bin/env bash
# nixenv - Manage ephemeral Nix shell environments

ENVS_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/nixenv/envs"

show_help() {
    cat << EOF
nixenv - Manage ephemeral Nix shell environments

Usage: nixenv [COMMAND] [ENV_NAME] [OPTIONS]

Commands:
    list, ls              List all available environments
    enter <env>           Enter an environment shell
    show <env>            Show environment definition
    new <env>             Create a new environment definition
    edit <env>            Edit an environment definition
    help                  Show this help message

Examples:
    nixenv ls             # List all environments
    nixenv enter pwn      # Enter the pwn environment
    nixenv show pwn       # Show pwn environment definition
    nixenv new crypto     # Create new crypto environment
    nixenv edit pwn       # Edit pwn environment

Environment definitions are stored in:
    $ENVS_DIR

Each environment is a simple Nix expression file.
EOF
}

list_envs() {
    if [ ! -d "$ENVS_DIR" ]; then
        echo "No environments found. Create one with: nixenv new <name>"
        return 1
    fi

    echo "Available environments:"
    for env in "$ENVS_DIR"/*.nix; do
        if [ -f "$env" ]; then
            name=$(basename "$env" .nix)
            # Extract description if present
            desc=$(grep "# Description:" "$env" | sed 's/# Description: //')
            if [ -n "$desc" ]; then
                printf "  %-15s - %s\n" "$name" "$desc"
            else
                printf "  %s\n" "$name"
            fi
        fi
    done
}

show_env() {
    local env_name="$1"
    local env_file="$ENVS_DIR/${env_name}.nix"

    if [ ! -f "$env_file" ]; then
        echo "Error: Environment '$env_name' not found"
        echo "Available environments:"
        list_envs
        return 1
    fi

    cat "$env_file"
}

enter_env() {
    local env_name="$1"
    shift
    local env_file="$ENVS_DIR/${env_name}.nix"

    if [ ! -f "$env_file" ]; then
        echo "Error: Environment '$env_name' not found"
        echo "Available environments:"
        list_envs
        return 1
    fi

    echo "Entering $env_name environment..."
    nix-shell "$env_file" "$@" --run zsh
}

new_env() {
    local env_name="$1"
    local env_file="$ENVS_DIR/${env_name}.nix"

    mkdir -p "$ENVS_DIR"

    if [ -f "$env_file" ]; then
        echo "Error: Environment '$env_name' already exists"
        echo "Use 'nixenv edit $env_name' to modify it"
        return 1
    fi

    cat > "$env_file" << 'EOF'
# Description: Enter a brief description here
{ pkgs ? import <nixpkgs> {} }:

pkgs.mkShell {
  buildInputs = with pkgs; [
    # Add your packages here
    # Example: gdb python3 pwntools
  ];

  shellHook = ''
    echo "Entering environment..."
    # Add custom initialization here
  '';
}
EOF

    echo "Created new environment: $env_name"
    echo "Edit it with: nixenv edit $env_name"
    
    # Open in editor if available
    if [ -n "$EDITOR" ]; then
        $EDITOR "$env_file"
    fi
}

edit_env() {
    local env_name="$1"
    local env_file="$ENVS_DIR/${env_name}.nix"

    if [ ! -f "$env_file" ]; then
        echo "Error: Environment '$env_name' not found"
        echo "Create it with: nixenv new $env_name"
        return 1
    fi

    ${EDITOR:-nvim} "$env_file"
}

# Main command dispatcher
case "$1" in
    list|ls)
        list_envs
        ;;
    enter)
        if [ -z "$2" ]; then
            echo "Error: Environment name required"
            echo "Usage: nixenv enter <env_name>"
            exit 1
        fi
        enter_env "$2" "${@:3}"
        ;;
    show)
        if [ -z "$2" ]; then
            echo "Error: Environment name required"
            echo "Usage: nixenv show <env_name>"
            exit 1
        fi
        show_env "$2"
        ;;
    new)
        if [ -z "$2" ]; then
            echo "Error: Environment name required"
            echo "Usage: nixenv new <env_name>"
            exit 1
        fi
        new_env "$2"
        ;;
    edit)
        if [ -z "$2" ]; then
            echo "Error: Environment name required"
            echo "Usage: nixenv edit <env_name>"
            exit 1
        fi
        edit_env "$2"
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        list_envs
        ;;
    *)
        echo "Error: Unknown command '$1'"
        echo "Run 'nixenv help' for usage information"
        exit 1
        ;;
esac
